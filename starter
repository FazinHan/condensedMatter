#!/bin/bash
#SBATCH -A physics_engg
#SBATCH --job-name=tilted.fermion
#SBATCH --output=output_run1/fermion.out
#SBATCH --error=output_run1/fermion.err
#SBATCH --partition=cpu
#SBATCH --cpus-per-task=1
#SBATCH --mem-per-cpu=52M
#SBATCH --array=1-5000%5000
#SBATCH --time=08:00:00
#SBATCH --mail-user=fizaan.khan.phy21@iitbhu.ac.in
#SBATCH --export=NONE
#SBATCH --signal=B:SIGUSR2@300

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# Init block: Signal when walltime is near
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# Using #SBATCH to send signal (details in "create_input.py")
# Define a function to execute and then catch the signal
timesup() {
    echo
    echo "Oh no! I am approaching the time limit ..."
    echo "I will gather some important things before it is too late!"
    echo
    /home/advikg.phy21.itbhu/gars_work/testgrid/emergency_stop.sh ${runstring[*]}
}

trap  "timesup"  SIGUSR2


echo "========= Job started  at `date` on `hostname -s` =========="

export OMP_NUM_THREADS=1

echo "Array job id : $SLURM_ARRAY_JOB_ID"
echo "Job id       : $SLURM_JOB_ID"
echo "Array task id: $SLURM_ARRAY_TASK_ID"

module load conda

python mkdir.py

runstring=(`echo ${SLURM_ARRAY_TASK_ID:-1}`)
echo "Track-ID: ${runstring[0]}"

python main.py ${runstring[*]} &
wait $!

echo "========= Job finished at `date` =========="
